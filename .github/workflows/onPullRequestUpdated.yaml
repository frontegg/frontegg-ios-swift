name: "onPullRequestUpdated"

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
    branches:
      - master

jobs:
  validate-pr:
    name: "Validate PR Description"
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get Pull Request Description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_metadata=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
           -H "Accept: application/vnd.github+json" \
           "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}")

          # Extract the description (body field)
          DESCRIPTION=$(echo "$pr_metadata" | jq -r '.body')

          if [ "$DESCRIPTION" != "null" ]; then
            echo "Pull Request Description: $DESCRIPTION"
          else
            echo "No description provided in the pull request. The 'release/next' branch must provide a description for the correct generation of the 'CHANGELOG.md' file."
            exit 1
          fi

  unit-tests:
    name: "Run Unit Tests"
    runs-on: 'macos-15-xlarge'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check macOS and Xcode versions
        run: |
          sw_vers
          xcode-select --print-path
          xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20

      - name: Run Unit Tests
        run: |
          # Find an available iPhone simulator
          SIMULATOR=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*(\([^)]*\)).*/\1/' | head -1)
          echo "Using simulator: $SIMULATOR"
          
          # Run tests
          set -o pipefail
          xcodebuild test \
            -scheme FronteggSwift \
            -destination "platform=iOS Simulator,id=$SIMULATOR" \
            -only-testing:FronteggSwiftTests \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            2>&1 | tee build.log
          
          # Extract test summary
          grep -E "Test Suite|Executed|TEST SUCCEEDED|TEST FAILED" build.log || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            TestResults.xcresult
            test-results.xml
          retention-days: 7

  build-and-lint:
    name: "Build & Lint"
    runs-on: 'macos-15-xlarge'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build for Testing
        run: |
          xcodebuild CC=clang CPLUSPLUS=clang++ LD=clang LDPLUSPLUS=clang++ \
            build-for-testing \
            -scheme "demo" \
            -project "demo/demo.xcodeproj" \
            -destination "platform=iOS Simulator,name=iPhone 16 Pro" \
            -configuration "Debug"

      - name: Validate CocoaPods
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          pod lib lint --verbose --allow-warnings